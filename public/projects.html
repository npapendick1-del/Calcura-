<!doctype html>
<html lang="de">
<head>
    <!-- Einheitliches Design laden -->
<link rel="stylesheet" href="style.css">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Projektverwaltung</title>
<style>
:root{--txt:#0b1220;--muted:#6b7280;--card:#f8fafc;--brand:#2563eb;}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;color:var(--txt)}
header{padding:16px 20px;border-bottom:1px solid #eef2f7}
main{max-width:1100px;margin:0 auto;padding:20px;display:grid;gap:16px}
.card{background:var(--card);border:1px solid #e5e7eb;border-radius:12px;padding:14px}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input,textarea,select{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;font:inherit}
.row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
button{padding:10px 14px;border:0;border-radius:10px;background:var(--brand);color:#fff;cursor:pointer}
a.btn{display:inline-block;padding:10px 12px;border-radius:10px;background:#e5e7eb;color:#111827;text-decoration:none}
table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
th,td{padding:10px;border-bottom:1px solid #edf0f4;text-align:left;font-size:14px}
td.actions{white-space:nowrap}
.ghost{background:#e5e7eb;color:#111827;border:0;border-radius:10px;padding:8px 10px;cursor:pointer}
</style>
</head>
<body>
<header><h1>Projektverwaltung</h1></header>
<main>
  <div class="card">
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <a class="btn" href="/dashboard.html">← Zurück</a>
      <button id="addBtn">Neues Projekt</button>
    </div>
  </div>

  <div class="card" id="formCard" style="display:none">
    <div class="row">
      <div><label>Titel</label><input id="p_title"></div>
      <div><label>Kunde</label>
        <select id="p_customerId"></select>
      </div>
      <div><label>Status</label>
        <select id="p_status">
          <option value="offen">offen</option>
          <option value="laufend">laufend</option>
          <option value="abgeschlossen">abgeschlossen</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><label>Budget (€)</label><input id="p_budget" type="number" step="0.01"></div>
      <div style="grid-column: span 2"><label>Notiz</label><input id="p_note"></div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px">
      <button id="saveBtn">Speichern</button>
      <button class="ghost" id="cancelBtn">Abbrechen</button>
    </div>
  </div>

  <div class="card">
    <table id="tbl">
      <thead><tr><th>Titel</th><th>Kunde</th><th>Status</th><th>Budget</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</main>
<script>
const tbody = document.querySelector("#tbl tbody");
const formCard = document.getElementById("formCard");
const cSel = document.getElementById("p_customerId");
const f = id => document.getElementById(id);
let editId = null;
let customers = [];

function euro(n){ return Number(n||0).toLocaleString("de-DE",{style:"currency",currency:"EUR"}); }
function escape(s){return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]))}

async function loadCustomers(){
  const res = await fetch("/api/customers");
  const data = await res.json();
  customers = data.items || [];
  cSel.innerHTML = `<option value="">– auswählen –</option>` + customers.map(c=>`<option value="${c.id}">${escape(c.name)}</option>`).join("");
}
function customerName(id){ return customers.find(c=>c.id===id)?.name || "—"; }

function openForm(item=null){
  formCard.style.display = "block";
  editId = item?.id || null;
  f("p_title").value = item?.title || "";
  f("p_customerId").value = item?.customerId || "";
  f("p_status").value = item?.status || "offen";
  f("p_budget").value = item?.budget || 0;
  f("p_note").value = item?.note || "";
}
function closeForm(){ formCard.style.display = "none"; }

async function load(){
  await loadCustomers();
  const res = await fetch("/api/projects");
  const data = await res.json();
  tbody.innerHTML = (data.items||[]).map(it=>`
    <tr>
      <td>${escape(it.title)}</td>
      <td>${escape(customerName(it.customerId))}</td>
      <td>${escape(it.status)}</td>
      <td>${euro(it.budget)}</td>
      <td class="actions">
        <button class="ghost" onclick='edit("${it.id}")'>Bearbeiten</button>
        <button class="ghost" onclick='delp("${it.id}")'>Löschen</button>
      </td>
    </tr>
  `).join("") || "<tr><td colspan='5'>Keine Projekte</td></tr>";
}
async function create(){
  const body = collect();
  const res = await fetch("/api/projects", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body)});
  if(!res.ok) return alert("Fehler beim Anlegen");
  closeForm(); load();
}
async function update(){
  const body = collect();
  const res = await fetch("/api/projects/"+editId, {method:"PUT", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body)});
  if(!res.ok) return alert("Fehler beim Speichern");
  closeForm(); load();
}
async function delp(id){
  if(!confirm("Projekt löschen?")) return;
  const res = await fetch("/api/projects/"+encodeURIComponent(id), {method:"DELETE"});
  if(!res.ok) return alert("Löschen fehlgeschlagen");
  load();
}
function collect(){
  return {
    title: f("p_title").value,
    customerId: f("p_customerId").value,
    status: f("p_status").value,
    budget: Number(f("p_budget").value||0),
    note: f("p_note").value
  };
}
function edit(id){
  Promise.all([
    fetch("/api/projects").then(r=>r.json()),
    fetch("/api/customers").then(r=>r.json())
  ]).then(([p,c])=>{
    customers = c.items||[];
    const it = (p.items||[]).find(x=>x.id===id);
    if(!it) return alert("Nicht gefunden");
    loadCustomers().then(()=>openForm(it));
  });
}

document.getElementById("addBtn").onclick = ()=>openForm();
document.getElementById("cancelBtn").onclick = closeForm;
document.getElementById("saveBtn").onclick = ()=> editId ? update() : create();
load();
</script>
</body>
</html>
