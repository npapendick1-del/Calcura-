<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>KI-Assistent</title>
  <style>
    :root{--txt:#0b1220;--muted:#6b7280;--bg:#fff;--line:#e5e7eb;--brand:#2563eb}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--txt);background:var(--bg)}
    header{padding:14px 20px;border-bottom:1px solid var(--line)} h1{margin:0;font-size:18px}
    main{max-width:1100px;margin:0 auto;padding:18px;display:grid;gap:14px}
    textarea{width:100%;min-height:180px;padding:12px;border:1px solid var(--line);border-radius:10px;font:inherit}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    button{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
    .ghost{background:#eef2f7;color:#111}
    table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
<header><h1>ü§ñ KI-Assistent</h1></header>
<main>
  <p class="muted">F√ºge hier z.B. eine Rechnung/Kostenvoranschlag als Text ein. Die KI extrahiert Positionen (Beschreibung, Menge, Einheit, Preis).</p>
  <textarea id="invoice" placeholder="Rechnungstext hier einf√ºgen ‚Ä¶"></textarea>
  <div class="row">
    <button id="parseBtn">Positionen erkennen</button>
    <button class="ghost" onclick="location.href='/dashboard.html'">Zur√ºck zum Dashboard</button>
  </div>

  <div id="result" style="display:none">
    <h3>Erkannte Positionen</h3>
    <table>
      <thead><tr><th>Beschreibung</th><th>Menge</th><th>Einheit</th><th>Einzelpreis (‚Ç¨)</th></tr></thead>
      <tbody id="items"></tbody>
    </table>
    <div class="row">
      <button id="toAppBtn">In Angebots-App √ºbernehmen</button>
    </div>
  </div>

  <pre id="raw" class="muted" style="white-space:pre-wrap"></pre>
</main>

<script>
const invoiceEl = document.getElementById("invoice");
const parseBtn  = document.getElementById("parseBtn");
const result    = document.getElementById("result");
const itemsTbody= document.getElementById("items");
const rawEl     = document.getElementById("raw");
const toAppBtn  = document.getElementById("toAppBtn");

parseBtn.onclick = async () => {
  const text = invoiceEl.value.trim();
  if(!text){ alert("Bitte Text einf√ºgen."); return; }

  parseBtn.disabled = true; parseBtn.textContent = "Wird analysiert‚Ä¶";
  rawEl.textContent = "";
  try{
    const res = await fetch("/api/invoice/parse", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ text })
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data?.error || "Analyse fehlgeschlagen.");

    // Fallback: falls dein Backend die Items flach unter data.items liefert
    const items = data.items || data?.parsed?.items || [];
    itemsTbody.innerHTML = "";
    for(const it of items){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${(it.desc||it.description||"").toString()}</td>
        <td>${Number(it.qty||it.quantity||0)}</td>
        <td>${(it.unit||"").toString()}</td>
        <td>${Number(it.unitPrice||it.price||0)}</td>
      `;
      itemsTbody.appendChild(tr);
    }
    result.style.display = "block";

    // Speichere Items tempor√§r, damit ‚ÄûIn Angebots-App √ºbernehmen‚Äú funktioniert
    window.__parsedItems = items.map(it => ({
      desc: (it.desc||it.description||"").toString(),
      qty:  Number(it.qty||it.quantity||0),
      unit: (it.unit||"").toString(),
      unitPrice: Number(it.unitPrice||it.price||0),
    }));

    rawEl.textContent = JSON.stringify(data, null, 2);
  }catch(e){
    alert(e.message);
  }finally{
    parseBtn.disabled = false; parseBtn.textContent = "Positionen erkennen";
  }
};

toAppBtn.onclick = () => {
  const arr = Array.isArray(window.__parsedItems) ? window.__parsedItems : [];
  if(!arr.length){ alert("Keine Positionen vorhanden."); return; }
  localStorage.setItem("meisterki_items", JSON.stringify(arr));
  location.href = "/app.html";
};
</script>
</body>
</html>
